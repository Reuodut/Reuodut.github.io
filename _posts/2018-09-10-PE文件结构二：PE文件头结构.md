---
layout: post
title: "PE文件结构二：PE文件头结构"
date: 2018-08-30 
description: "PE文件头结构体：IMAGE_NT_HEADERS STRUCT"
tag: 逆向工程 
---   



###  PE文件头结构体：IMAGE_NT_HEADERS STRUCT

    typedef struct _IMAGE_NT_HEADERS 
    {
    +00h DWORD Signature
    +04h IMAGE_FILE_HEADER FileHeader
    +18h IMAGE_OPTIONAL_HEADER32 OptionalHeader 
    } IMAGE_NT_HEADERS ENDS, *PIMAGE_NT_HEADERS32;
    
该结构体包含一个变量和2个结构体

DWORD Signature

IMAGE_FILE_HEADER FileHeader

IMAGE_OPTIONAL_HEADER32 OptionalHeader




#### 1.Signature字段
在一个有效的 PE 文件里，Signature 字段被设置为00004550h, ASCII 码字符是“PE00”，标志这 PE 文件头的开始。DOS 头部的 e_lfanew 字段正是指向这里。

![](/imag/20180910/e_lfanew.png)

#### 2.子结构体一：IMAGE_FILE_HEADER

    typedef struct _IMAGE_FILE_HEADER 
    { 
    +04h WORD Machine;               // 运行平台  
    +06h WORD NumberOfSections;      // 文件的区块数目  
    +08h DWORD TimeDateStamp;        // 文件创建日期和时间  
    +0Ch DWORD PointerToSymbolTable; // 指向COFF符号表(主要用于调试)  
    +10h DWORD NumberOfSymbols;      // COFF符号表中符号个数(同上)  
    +14h WORD SizeOfOptionalHeader;  // IMAGE_OPTIONAL_HEADER32 结构大小  
    +16h WORD Characteristics;       // 文件属性  
    } IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;
    
![](/imag/20180910/IMAGE_FILE_HEADER.png)
    

++（1）Machine：可执行文件的目标CPU类型。++

Value | Machine
---|---
IMAGE_FILE_MACHINE_I386   ==0x014c==| x86
IMAGE_FILE_MACHINE_IA64   ==0x0200==| Intel Itanium
IMAGE_FILE_MACHINE_AMD64  ==0x8664==| x64

++（2）NumberOfSection: 区块的数目。（注：区块表是紧跟在 IMAGE_NT_HEADERS 后边的）++

++（3）TimeDataStamp: 表明文件是何时被创建的。++

这个值是自1970年1月1日以来用格林威治时间（GMT）计算的秒数，这个值是比文件系统（FILESYSTEM）的日期时间更加精确的指示器。提示：VC的话可以用_ctime 函数或者 gmtime 函数。



#### 3.子结构体二：IMAGE_OPTIONAL_HEADER32

 
 
 DWORD e_magic为"MZ",定义为IMAGE_DOS_SIGNATURE
 
 LONG e_lfanew存放PE头的文件偏移量。

    #define IMAGE_DOS_SIGNATURE 0x4D5A    // MZ 
    #define IMAGE_OS2_SIGNATURE 0x4E45    // NE
    #define IMAGE_OS2_SIGNATURE_LE 0x4C45 // LE 
    #define IMAGE_NT_SIGNATURE 0x50450000 // PE00

###  DOS Stub

它是一个总是由大约100个字节所组成的和MS-DOS 2.0兼容的可执行体，用来输出象
“this program needs windows NT”之类的错误信息。win32系统都直接跳过DOS Stub定
位到PE头。

![](/imag/20180910/DOS_Stub.png)










